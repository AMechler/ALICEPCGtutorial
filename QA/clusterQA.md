# ClusterQA

**This part of the QA must be run for any calorimeter related analysis (for EMCal/PHOS/DCal and hybrid analyses PCM-EMCal, PCM-PHOS, PCM-DCal)**

## Identify Bad Cells

For bad cell identification, we need the output from GammaCalo with cellQA output contained (perferably option '5') downloaded runwise.

**1. Run QA_RunwiseV2.C**
with doEventQA = kTRUE and doClusterQA = kTRUE (doMergedQA for EMCal merged analysis) with doExtQA == 2! (important for cell level output) using data + MC input in order to generate all needed histograms + txt-files for bad cell identification

Important _example_ histograms for the runwise QA and bad cell identification (plots are from the QA stage and include cells which were declared as bad in the meantime):

* Number of Clusters per event
![](/QA/figures/ClusterQA/hCaloNClustersQA.jpg)

* Cluster eta/phi maps for each run for data and MC - a difference can be clearly seen which **MUST** be corrected in MC (switch off the given RCUs for MC)
![](/QA/figures/ClusterQA/hClusterEtaPhi_scaledNEventsAndMean_p0.jpg)
![](/QA/figures/ClusterQA/hClusterEtaPhi_scaledNEventsAndMean_p0_MC.jpg)


**2. CellQA step: identify dead and warm/hot cells comparing data and MC information**
Check histograms created in _ExtQA/*_ and especially _ExtQA/MissingCells/*_ for dead cells. Dead/warm/hot cell identification by comparing the cells EFrac to mean EFrac of neighboring cells 

> EFrac = cells energy fraction of full cluster energy, summed over all events --> turned out to be a much better discriminator than just looking how often cells fired

An example of the EFrac plotted versus CellID which is generated by the RunwiseQA:
![](/QA/figures/ClusterQA/hClusterEFracCellsBefore_p0.jpg)

We have a dead cell candidate:
* if((nCurrentEFrac$$<$$mean/3 && mean$$>=$$80) || (nCurrentEFrac$$<$$mean/5 && mean$$>=$$40 && mean$$<$$80) || (nCurrentEFrac$$<$$mean/8 && mean$$>=$$10 && mean$$<$$40) || (nCurrentEFrac$$<$$mean/10 && mean$$<$$10))

A warm/hot cell candidate:
* if((nCurrentEFrac$$>$$2*mean && nCurrentEFrac$$>$$80) || (nCurrentEFrac$$>$$3*mean && nCurrentEFrac$$>$$20) || (nCurrentEFrac$$>$$4*mean && nCurrentEFrac$$>$$8) || (nCurrentEFrac$$>$$5*mean && nCurrentEFrac$$>$$5))

Above conditions for dead/warm/hot cell candidate identification are being applied in function _CheckHotAndColdCellsEFracRunwise_ in QA.h! Be careful that a minimum number of events is needed to process the run in this function (runs with ultra low statistics are excluded as it is impossible to look for hot/dead cells besides the obvious candidates which should then appear in other runs as well)
The resulting dead/warm/hot cells are written to respective _*.log_ files that can be found in the output folder. 

The hot cell candidates are summarized in such plots (How often does a cell fire per run and how many hot cell candidates are available per run):
![](/QA/figures/ClusterQA/HotCells_FiredInNRuns_0.jpg)
![](/QA/figures/ClusterQA/HotCells_Runwise_0.jpg)

Example how the HotCellsRunwise looks like:

```
Run-189306
NoNoisyCellsFound!
Run-189310
1872-CellEFraction:86.2982-CurrentMean:42.4863
5824-CellEFraction:162.839-CurrentMean:34.1267
5825-CellEFraction:155.015-CurrentMean:34.1267
5833-CellEFraction:243.445-CurrentMean:34.1719
10095-CellEFraction:83.0187-CurrentMean:26.2337
11052-CellEFraction:94.292-CurrentMean:36.1453
Run-189350
10095-CellEFraction:52.5966-CurrentMean:17.4002
11052-CellEFraction:71.3287-CurrentMean:22.9911
```

Example how the DeadCellsRunwise looks like:

```
Run-191245
NotEnoughCellsFired-67759-ToObtainColdChannels!
NoColdCellsFound!
Run-191247
NotEnoughCellsFired-87926-ToObtainColdChannels!
NoColdCellsFound!
Run-191248
46-CellEFraction:0.348177-CurrentMean:5.78061
74-CellEFraction:0-CurrentMean:5.78061
103-CellEFraction:0-CurrentMean:5.78061
128-CellEFraction:0-CurrentMean:5.81746
152-CellEFraction:0-CurrentMean:5.72
198-CellEFraction:0-CurrentMean:5.00258
328-CellEFraction:0.23663-CurrentMean:5.02124
353-CellEFraction:0-CurrentMean:5.15569
594-CellEFraction:0-CurrentMean:4.84653
747-CellEFraction:0.390729-CurrentMean:4.39367
759-CellEFraction:0-CurrentMean:4.37241
846-CellEFraction:0.36234-CurrentMean:3.93415
917-CellEFraction:0-CurrentMean:3.63333
1002-CellEFraction:0-CurrentMean:4.16652
1038-CellEFraction:0-CurrentMean:4.18485
1051-CellEFraction:0.346459-CurrentMean:4.21454
```

The next steps 3./4. are needed as by statistical fluctuations some cells can fire more often or less often than usual, therefore we need to apply further conditions for dead/hot cell identification:

**3. Check Dead-Cells for different runs via ClusterQA_DeadCellCompareV2.C **
This macro can be run using by enabling the 'doCellQASummary' as last parameter in the QAV2.C, by default this parameter is set to kFALSE. 
It will then check if the config-file contains the bare minimum of settings to run the ClusterQA_DeadCellCompareV2.C and proceed with the running if this is the case. Thus you will need to add the following lines to your configuration file:
```
# Settings for dead cell compare macro
addLabelRunlist _dpgTracks
deadCellNSets   1
deadCellNMCSets 1
deadCellNTrigger    1
deadCellDataSetNames LHC16qt    STOP
deadCellMCSetNames  LHC17f2b STOP
deadCellAdditionalOutputDirName LHC16qt
nCaloCells  18000
# deadCellTriggerNames  INT7    STOP
deadCellMCCuts  80000513_2444400051013200000_0163103100000010   STOP
deadCellDataCuts    80000513_2444400051013200000_0163103100000010   STOP
deadCellFractionThesh   0.6
```
If you want to run the macro without starting QAV2.C you have to create a new configuration file which contains the full set of parameters needed, like [configDeadCellQA_LHC16qt_PHOS.txt](/assets/configDeadCellQA_LHC16qt_PHOS.txt). In that case it can be started with:
```
root -b -l -q -x 'TaskQA/ClusterQA_DeadCellCompareV2.C+("Config_files/configLHC16qt_CellQA_PHOS.txt","pdf")'
```

The determination of dead cells is done using the for-loop around _line 364_. 
Different decisions when to consider dead cells:
* if cell is dead cell candidate in consecutive number of runs (currently set up with 4), 
* if at least 10 dead cell candidates are found with in the same run range or cell candidate is identified to be dead in a given % of analysed runs, represented by fractionThesh.

All results are written/summarized in log-files (examples):

```
CellID:198,cold/notFiredInRuns:176701,176730,176749,176753,176926,176927,176929,177011,177148,177173,177180,177182,
CellID:871,cold/notFiredInRuns:176715,176730,176749,176753,176854,176859,176926,176927,176929,177011,
CellID:1002,cold/notFiredInRuns:176927,
CellID:1306,cold/notFiredInRuns:176854,
CellID:1682,cold/notFiredInRuns:176730,176749,176753,176926,176927,
CellID:1683,cold/notFiredInRuns:176730,176749,176753,
CellID:1735,cold/notFiredInRuns:176927,
CellID:2069,cold/notFiredInRuns:176730,176749,176753,176926,176927,176929,
CellID:2171,cold/notFiredInRuns:176926,
CellID:2179,cold/notFiredInRuns:176730,176749,176753,176926,176927,
CellID:2306,cold/notFiredInRuns:176749,
CellID:2312,cold/notFiredInRuns:176749,177011,
CellID:2313,cold/notFiredInRuns:176715,176730,176749,176753,176854,176924,176926,176927,176929,177011,177167,177182,
```

and according to the selection criteria the final list of dead cells:

```
198 in 70.5882% of selected runs dead/cold
871 in 58.8235% of selected runs dead/cold
2313 in 70.5882% of selected runs dead/cold
2395 in 70.5882% of selected runs dead/cold
2778 in 52.9412% of selected runs dead/cold
3940 in 58.8235% of selected runs dead/cold
10086 in 58.8235% of selected runs dead/cold
11091 in 70.5882% of selected runs dead/cold
```

**4. Check Hot-Cells for different runs via ClusterQA_HotCellCompareV2.C **
As for the previous step, this macro can be run by enabling the 'doCellQASummary' as last parameter in the QAV2.C.
It will then check if the config-file contains the bare minimum of settings to run the ClusterQA_HotCellCompareV2.C and proceed with the running if this is the case. Thus you will need to add the following lines to your configuration file:
```
# Settings for hot cell compare macro
hotCellNSets   1
hotCellNTrigger    1
hotCellDataSetNames LHC16qt    STOP
hotCellAdditionalOutputDirName LHC16qt
# hotCellTriggerNames  INT7    STOP
hotCellDataCuts    80000513_2444400051013200000_0163103100000010   STOP
hotCellThreshNFired   0
hotCellThreshNTotalFired   60
```
If you want to run the macro without starting QAV2.C you have to create a new configuration file which contains the full set of parameters needed, like [configHotCellQA_LHC16qt_PHOS.txt](/assets/configHotCellQA_LHC16qt_PHOS.txt).
The macro can then be started with the following command:
```
root -b -l -q -x 'TaskQA/ClusterQA_HotCellCompareV2.C+("Config_files/configHotCellQA_LHC16qt_PHOS.txt","pdf")'
```

Determination of warm/hot cells using for-loop around line 248 via 'threshNFired' and 'threshNTotalFired' for 3. + 4. produce output log-files which summarize the bad cells to be excluded in OADB from runwise dead/warm/hot cell determination. 

All hot cell candidates are written/summarized in log-files 

```
CellID: 5602, occurred for first time in run: 177180, in total noisy in - 2 - differentRuns, where it occurred in clusters 370.715 times! That is 10.3574 times than the average of neighboring cells!
CellID: 5860, occurred for first time in run: 176730, in total noisy in - 6 - differentRuns, where it occurred in clusters 956.856 times! That is 2.28916 times than the average of neighboring cells!
CellID: 6835, occurred for first time in run: 176730, in total noisy in - 6 - differentRuns, where it occurred in clusters 884.416 times! That is 2.15624 times than the average of neighboring cells!
CellID: 6933, occurred for first time in run: 176730, in total noisy in - 5 - differentRuns, where it occurred in clusters 1038.84 times! That is 2.14903 times than the average of neighboring cells!
CellID: 7104, occurred for first time in run: 176730, in total noisy in - 4 - differentRuns, where it occurred in clusters 851.255 times! That is 2.14486 times than the average of neighboring cells!
CellID: 8420, occurred for first time in run: 176730, in total noisy in - 2 - differentRuns, where it occurred in clusters 299.125 times! That is 2.23993 times than the average of neighboring cells!
```

and according to the selection criteria the final list of hot cells (sorted by run or sorted by cell ID):

(cell ID / run number)
```
11198 176715
11102 176730
11185 176730
11197 176730
11200 176730
11377 176730
5860 176730
6835 176730
6933 176730
7104 176730
8420 176730
8465 176730
8467 176730
8916 176730
9024 176730
9219 176730
9886 176730
10514 176749
9403 176749
11148 176753
9899 176859
5602 177180
```

After identifying dead/hot cells on runwise level, the general periodwise level CellQA + ClusterQA step follows


**5. CellQA step on periodwise level via running of ClusterQA.C**
identify bad cells on periodwise level by using data and MC information. 

> Setting for bad cell identification are defined in QAV2.C (Double\_t arrQAEnergy[4]; Double\_t arrQATime[4]; Double\_t arrQAHotCells1D[4]; Double\_t arrmin2D[9]; Double\_t arrmax2D[9];)

The cell IDs are also written to the log-file which is generated:
```
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Suspicious cells from: Energy - Mean/Sigma
Total number of 1 cells
11044, 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Suspicious cells from: Time - Mean/Sigma
Total number of 28 cells
3659, 3750, 3755, 3801, 4090, 4228, 4233, 5767, 5824, 5825, 5833, 7375, 9444, 9445, 9450, 9451, 9880, 9881, 9940, 9941, 10080, 10083, 10085, 10089, 10091, 10095, 10718, 10759, 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Suspicious cells from: HotCells1D
Total number of 7 cells
3659, 9881, 9940, 10095, 10718, 11044, 11052, 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Suspicious cells from: HotCellsTime1D
Total number of 28 cells
2245, 2581, 2665, 2745, 2884, 3659, 3740, 3750, 4230, 5767, 5824, 5825, 5833, 7375, 9450, 9451, 9880, 9881, 9940, 9941, 10080, 10083, 10085, 10089, 10091, 10095, 10718, 10759, 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Suspicious cells from: HotCells2D
Total number of 0 cells

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Suspicious cells from: Missing MC-Data
Total number of 0 cells

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
AllCells.size before sort and unique: 64.Finally 37 different cells found!
2245, 2581, 2665, 2745, 2884, 3659, 3740, 3750, 3755, 3801, 4090, 4228, 4230, 4233, 5767, 5824, 5825, 5833, 7375, 9444, 9445, 9450, 9451, 9880, 9881, 9940, 9941, 10080, 10083, 10085, 10089, 10091, 10095, 10718, 10759, 11044, 11052,
```

An overview plot is generated with an overview by which cut a cell has been identified as bad candidate (the cell IDs are also stored in log-files):
![](/QA/figures/ClusterQA/ReasonsBadCell_LHC12h_0.jpg)

Furthermore, the energy and time distributions are plotted for data and MC:

![](/QA/figures/ClusterQA/CellEnergyVsCellID_LHC12h_0.jpg)
![](/QA/figures/ClusterQA/CellEnergyVsCellID_LHC14e2a-LHC12h_0.jpg)

![](/QA/figures/ClusterQA/CellTimeVsCellID_LHC12h_0.jpg)
![](/QA/figures/ClusterQA/CellTimeVsCellID_LHC14e2a-LHC12h_0.jpg)

Real bad cell candidates are immediately visible in comparison to the rest of candidates.

In addition, the energy distribution of each cell candidate is compared between data and MC (normalized to the number of events) to help with the judgement if cells are really bad:

![](/QA/figures/ClusterQA/Cell10091_EnergyComparison.jpg)

Compare data/MC energy and time distributions for all bad cell candidates found in 5. Also use 8. 

Then, merge bad cell candidate list from 5. with lists found in 3. and 4. to be excluded in OADB 

**6. Run ClusterQA_CellCompare (needs to be configured within macro - not _yet_ included in steering macros)**
to visualize bad cell candidates found in step 5.

An overview plot is generated with an full overview in which period a cell has been identified as bad candidate:
![](/QA/figures/ClusterQA/BadCellCandidates_0.jpg)


## Run ClusterQA

The cluster QA covers general cluster+cell properties like:

**generated histograms (list of examples)** (full set of generated histograms can be deduced from the macros themselves/or from the output generated):
* Cut overview histograms (vs. $$p_T$$)
* Cell histograms (number of cells fired, cell energy/timing,...)
* Cluster histograms (number of clusters per event, eta/pi distributions,...)

Running the ClusterQA(_Runwise).C will save the output into the following folder structure: 
> _CUTNUMBER/SYSTEM/EventQA/_ 

In addition, *.root files will be generated in _CUTNUMBER/SYSTEM/_ containing all the histograms as well.

**7. Runwise ClusterQA step by analysing output from ClusterQA_Runwise.C**
Carefully check all output from runwise histograms with special focus on data/MC comparison (Is the MC able to reproduce all QA histograms extracted from data? Does the MC follow the trends seen in data? Are there any suspicious runs or any observations that cannot be explained?...)

**8. ClusterQA step by analysing output from ClusterQA.C** 
Carefully check all output from histograms with special focus on data/MC comparison (Is the MC able to reproduce all QA histograms extracted from data? Does the MC follow the distributions seen in data? Are there any suspicious observations or is there anything that cannot be explained?...)

**9. Optional: run ClusterQA_Compare (needs to be configured within macro - not _yet_ included in steering macros)**
to compare different data sets (MB vs calorimeter trigger for example for a given dataset; needs input from runwiseQA and periodwiseQA) 

Carefully check all output from runwise/full output with special focus on data/MC comparison (Is the MC able to reproduce all QA histograms extracted from data? Does the MC follow the trends seen in data? Are there any suspicious runs or any observations that cannot be explained?...) In general, they should be stable vs. run number - however, one of the exceptions is pileup which may vary from run to run -> need to be taken with special care!


## Debug Mode / Visualise Clusters

There is an existing option to write specific clusters to a txt-file with the _GammaCalo_ task (for example cluster combinations with a very small opening angle or select especially huge clusters,...). Once you produced the txt-files with help of the _GammaCalo_ task, you can visualize the clusters by help of the macro _Grid\_PlotGammaCaloDebug_ which can be found in _TaskQA_.

It can be called via:

> Grid\_PlotGammaCaloDebug(TString filePath = "/home/daniel/data/work/debugOutput.txt", TString outputDir = "DebugPlots", Bool\_t plotFullEMCal = kFALSE, Int\_t debugOption = 0)
